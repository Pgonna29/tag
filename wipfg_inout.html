<!DOCTYPE html>
<html lang="th" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>WIPFG ¬∑ Enhanced Inventory System v3.0</title>
  <meta name="color-scheme" content="dark light" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    :root {
      /* Color Scheme */
      --bg: #0b1020;
      --panel: #0f172a;
      --card: #1e293b;
      --text: #e5e7eb;
      --text-muted: #94a3b8;
      --text-dim: #64748b;
      
      /* Theme Colors */
      --primary: #7c3aed;
      --primary-light: #8b5cf6;
      --secondary: #0ea5e9;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      
      /* UI Elements */
      --border: #334155;
      --border-light: #475569;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      --shadow-hover: 0 15px 35px rgba(0, 0, 0, 0.35);
      --blur: blur(12px);
      
      /* Gradients */
      --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      --gradient-success: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      --gradient-error: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
      --gradient-bg: radial-gradient(1000px 700px at 85% -10%, rgba(124, 58, 237, 0.08) 0%, transparent 60%),
                     radial-gradient(900px 600px at -10% 120%, rgba(14, 165, 233, 0.06) 0%, transparent 60%);
    }

    html[data-theme="light"] {
      --bg: #f8fafc;
      --panel: #ffffff;
      --card: #f1f5f9;
      --text: #0f172a;
      --text-muted: #475569;
      --text-dim: #64748b;
      --border: #e2e8f0;
      --border-light: #cbd5e1;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 15px 35px rgba(0, 0, 0, 0.15);
      --gradient-bg: radial-gradient(1000px 700px at 85% -10%, rgba(124, 58, 237, 0.03) 0%, transparent 60%),
                     radial-gradient(900px 600px at -10% 120%, rgba(14, 165, 233, 0.02) 0%, transparent 60%);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", "Prompt", system-ui, -apple-system, sans-serif;
      background: var(--gradient-bg), var(--bg);
      color: var(--text);
      font-weight: 400;
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* Enhanced Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 60;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    [data-theme="light"] .topbar {
      background: rgba(248, 250, 252, 0.9);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 18px;
    }

    .logo {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3);
      font-size: 16px;
    }

    .spacer {
      flex: 1;
    }

    /* Enhanced Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      border: 2px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 600;
      min-height: 44px;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      text-decoration: none;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-hover);
      border-color: var(--border-light);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.ghost {
      background: transparent;
      backdrop-filter: var(--blur);
    }

    .btn.pri {
      border: 0;
      background: var(--gradient-primary);
      color: #fff;
      box-shadow: 0 10px 25px rgba(124, 58, 237, 0.25);
    }

    .btn.pri:hover {
      box-shadow: 0 15px 35px rgba(124, 58, 237, 0.35);
    }

    /* Switch Component */
    .switch {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 25px;
      background: var(--panel);
      backdrop-filter: var(--blur);
    }

    .switch .cap {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
    }

    .switch input {
      display: none;
    }

    .slider {
      position: relative;
      width: 48px;
      height: 26px;
      background: var(--text-dim);
      border-radius: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .slider::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      top: 3px;
      background: #fff;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .switch input:checked + .slider {
      background: var(--success);
    }

    .switch input:checked + .slider::after {
      left: 25px;
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 20px auto 100px;
      padding: 0 20px;
    }

    /* Enhanced Navigation Tabs */
    .seg {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 12px 0 24px;
      padding: 8px;
      background: var(--panel);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .segbtn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      height: 80px;
      border-radius: 16px;
      border: 2px solid transparent;
      background: transparent;
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .segbtn:hover {
      background: var(--card);
      transform: translateY(-2px);
    }

    .segbtn.active {
      background: var(--gradient-primary);
      color: #fff;
      box-shadow: 0 12px 25px rgba(124, 58, 237, 0.25);
      border-color: rgba(124, 58, 237, 0.3);
    }

    .seg i {
      font-style: normal;
      font-size: 24px;
    }

    /* Enhanced Cards */
    .card {
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gradient-primary);
      opacity: 0.5;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .inner {
      padding: 24px;
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 0 0 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .section-title h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
    }

    /* Form Elements */
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-muted);
    }

    input, select, textarea {
      font: inherit;
      color: var(--text);
    }

    .input, .select, .note {
      width: 100%;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      outline: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 16px;
    }

    .input:focus, .select:focus, .note:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
      transform: translateY(-1px);
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
      margin-bottom: 20px;
    }

    /* Quantity Controls */
    .qty-container {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 8px;
    }

    .qty {
      width: 120px;
      text-align: center;
      background: transparent;
      border: none;
      padding: 8px;
      font-size: 20px;
      font-weight: 700;
      outline: none;
      color: var(--text);
    }

    .step {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: var(--panel);
      color: var(--text);
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .step:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: scale(1.05);
    }

    /* Status Grid */
    .status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }

    .sbox {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      transition: all 0.3s ease;
    }

    .sbox:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .sbox b {
      display: block;
      font-size: 12px;
      color: var(--secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .sbox span {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    /* Action Box */
    .action-box {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(220, 38, 38, 0.02) 100%);
      border: 2px solid var(--error);
      border-radius: 20px;
      padding: 20px;
      margin-top: 24px;
      position: relative;
      overflow: hidden;
    }

    .action-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.05), transparent);
      transition: left 0.8s;
    }

    .action-box:hover::before {
      left: 100%;
    }

    .action-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .action-title {
      font-weight: 700;
      color: var(--error);
      font-size: 16px;
    }

    .action-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .big {
      min-height: 70px;
      border: none;
      border-radius: 16px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .big::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transition: all 0.3s ease;
      transform: translate(-50%, -50%);
    }

    .big:active::before {
      width: 300px;
      height: 300px;
    }

    .big.in {
      background: var(--gradient-success);
      color: #fff;
      box-shadow: 0 12px 25px rgba(34, 197, 94, 0.3);
    }

    .big.in:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 35px rgba(34, 197, 94, 0.4);
    }

    .big.out {
      background: var(--gradient-error);
      color: #fff;
      box-shadow: 0 12px 25px rgba(239, 68, 68, 0.3);
    }

    .big.out:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 35px rgba(239, 68, 68, 0.4);
    }

    /* Enhanced Tables */
    .scroll {
      max-height: 60vh;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--panel);
    }

    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
    }

    .table thead th {
      position: sticky;
      top: 0;
      background: var(--card);
      color: var(--text-muted);
      text-align: left;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table td {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .table tr:hover td {
      background: rgba(124, 58, 237, 0.05);
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    

    /* === Column sizing & numeric alignment (added) === */
    .table th, .table td { vertical-align: middle; }
    /* Shrink most columns to content; let Note expand */
    .table .th-datetime, .table .th-type, .table .th-amount, .table .th-balance,
    .table .th-partno, .table .th-partname,
    .table td:not(.note-col) {
      white-space: nowrap;
    }
    .table .th-note, .table td.note-col {
      white-space: normal;
      width: auto;
    }
    /* Use minimal width for these columns so they fit their text */
    .table .th-datetime, .table .th-type, .table .th-amount, .table .th-balance,
    .table .th-partno, .table .th-partname { width: 1%; }
    /* Align numbers perfectly using tabular numerals */
    .table th.right, .table td.right,
    .table td[style*="text-align: right"] {
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1, "lnum" 1;
    }

.right {
      text-align: right;
    }

    /* Mobile List View */
    .list {
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .item {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 16px;
      padding: 16px;
      transition: all 0.3s ease;
    }

    .item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .item-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .item-sub {
      display: flex;
      gap: 16px;
      color: var(--text-muted);
      font-size: 13px;
      flex-wrap: wrap;
    }

    /* Tab System */
    .tab {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    .tab.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    /* Force Mobile Mode */
    .force-mobile .container {
      max-width: 600px;
    }

    .force-mobile .scroll {
      display: none;
    }

    .force-mobile .list {
      display: flex;
    }

    .force-mobile .qty-container {
      width: 100%;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .scroll {
        display: none;
      }
      
      .list {
        display: flex;
      }
      
      .container {
        padding: 0 16px;
      }
      
      .inner {
        padding: 20px;
      }
      
      .seg {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .segbtn {
        height: 70px;
      }
      
      .action-grid {
        grid-template-columns: 1fr;
      }
      
      .status {
        grid-template-columns: 1fr;
      }
    }

    /* Enhanced Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: var(--blur);
      display: none;
      z-index: 70;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .keypad-overlay {
      align-items: flex-end;
    }

    .modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      max-width: 400px;
      width: 100%;
    }

    .keypad-content {
      border-radius: 20px 20px 0 0;
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-weight: 700;
      color: var(--text);
      font-size: 16px;
    }

    .keypad-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 20px;
    }

    .keypad-btn {
      height: 60px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      font-size: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .keypad-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: scale(1.05);
    }

    .keypad-btn:active {
      transform: scale(0.95);
    }

    /* Scanner Modal */
    .scanner-content {
      position: relative;
      width: 100%;
      max-width: 400px;
      aspect-ratio: 3/4;
      background: #000;
      border-radius: 20px;
      overflow: hidden;
      border: 2px solid var(--primary);
      box-shadow: 0 0 40px rgba(124, 58, 237, 0.4);
    }

    .scanner-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .scanner-overlay {
      position: absolute;
      inset: 20%;
      border: 2px solid var(--success);
      border-radius: 12px;
      animation: scanPulse 2s infinite;
    }

    @keyframes scanPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.02); }
    }

    .scanner-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: white;
      padding: 8px 12px;
      backdrop-filter: var(--blur);
    }

    /* Loading Animation */
    .loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Success/Error Animations */
    .success-anim {
      animation: successPulse 0.6s ease;
    }

    .error-anim {
      animation: errorShake 0.4s ease;
    }

    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); filter: brightness(1.2); }
      100% { transform: scale(1); }
    }

    @keyframes errorShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 100;
    }

    .toast {
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      font-weight: 500;
      max-width: 350px;
      animation: slideInRight 0.3s ease;
      color: var(--text);
    }

    .toast.success {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .toast.error {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  
  /* Receive Modal Styles */
  .modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:9999;}
  .modal-overlay.show{display:flex;}
  .modal-card{background:var(--card);border:2px solid var(--border);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:520px;width:92%;padding:20px;}
  .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
  .modal-title{font-weight:700;font-size:18px;}
  .modal-body{display:grid;gap:12px;margin-top:8px;}
  .modal-row{display:grid;gap:6px;}
  .modal-foot{display:flex;gap:10px;justify-content:flex-end;margin-top:16px;}
  .modal-input{background:var(--bg);border:2px solid var(--border);border-radius:14px;padding:10px 12px;color:var(--text);outline:none;}
  .modal-input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(93,135,255,.15);}
  .btn{cursor:pointer;border:2px solid var(--border);background:var(--card);color:var(--text);padding:10px 14px;border-radius:14px;font-weight:600;}
  .btn-primary{border-color:transparent;background:linear-gradient(135deg,var(--primary),#8b5cf6);color:white;}
  .btn-ghost{background:transparent;}
  .hint{font-size:12px;color:var(--muted);}
</style>

<!-- Location Popup Styles -->
<style>
  .modal-overlay{
    position: fixed; inset: 0;
    display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,.55); backdrop-filter: blur(2px);
    z-index: 9999;
  }
  .modal-content{
    width: calc(100% - 32px);
    max-width: 560px;
    background: var(--card, #111);
    color: var(--text, #e7e7e7);
    border-radius: 16px;
    box-shadow: 0 8px 36px rgba(0,0,0,.45);
    border: 1px solid rgba(255,255,255,.08);
    overflow: hidden;
  }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    gap: 12px; padding: 14px 16px;
    background: rgba(255,255,255,.04);
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  .modal-title{
    font-weight: 800; letter-spacing:.3px;
  }
  .btn{
    appearance: none; border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06); color: var(--text, #e7e7e7);
    padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 700;
  }
  .btn.pri{
    border: none; background: linear-gradient(180deg,#5b8cff,#7aa2ff);
    color: #0b1020; text-shadow: 0 1px 0 rgba(255,255,255,.3);
  }
  .btn.big{ font-size: 18px; padding: 14px 16px; border-radius: 14px; }
  .loc-big{
    font-size: clamp(36px, 9vw, 72px);
    font-weight: 900;
    line-height: 1.1;
    letter-spacing: .5px;
    color: var(--text, #fff);
    text-align: center;
    padding: 12px 8px;
    word-break: break-word;
  }
  .loc-sub{
    color: var(--text-muted, #a6adbb);
    text-align: center;
    margin-top: 6px;
    font-weight: 600;
  }
</style>

<style>
/* out-flash-anim */
@keyframes popIn { from { transform: scale(.96); opacity:.0 } to { transform: scale(1); opacity:1 } }
@keyframes fadeInFlash { from { opacity:0 } to { opacity:1 } }
</style>

</head>
<body>
  <!-- Enhanced Topbar -->
  <div class="topbar">
    <div class="wrap">
      <div class="brand">
        <div class="logo">üì¶</div>
        <span>WIPFG</span>
      </div>
      <div class="spacer"></div>
      <button id="btnBackNav" class="btn ghost" href="wip.html">‚¨ÖÔ∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <button id="btnHomeNav" class="btn ghost"  href="index.html">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <label class="switch" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠">
        <input id="mobileToggle" type="checkbox">

        <span class="slider"></span>
        <span class="cap">‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</span>
      </label>
      <button id="themeToggle" class="btn ghost">üåô ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á</button>
      <button id="scanBtn" class="btn pri">üì± ‡∏™‡πÅ‡∏Å‡∏ô</button>
    </div>
  </div>

  <div class="container">
    <!-- Enhanced Navigation -->
    <div class="seg">
      <div class="segbtn active" data-nav="tab-make">
        <i>üì¶</i>
        <div>‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      </div>
      <div class="segbtn" data-nav="tab-history">
        <i>üìú</i>
        <div>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
      </div>
      <div class="segbtn" data-nav="tab-settings">
        <i>‚öôÔ∏è</i>
        <div>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
      </div>
    </div>

    <!-- Make Transaction Tab -->
    <section id="tab-make" class="tab active">
      <div class="card">
        <div class="inner">
          <div class="section-title">
            <h3>üîç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Part Number</h3>
            <div class="badge">‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå</div>
          </div>
          
          <div class="row">
            <div style="flex: 1; min-width: 280px;">
              <label>üè∑Ô∏è Part Number</label>
              <input id="partNoInput" class="input" list="partList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô Part Number">
              <datalist id="partList"></datalist>
            </div>
          </div>

          <div class="row">
            <div style="flex: 1;">
              <label>üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
              <div class="qty-container">
                <button class="step" id="minus1">‚àí</button>
                <input id="qtyInput" class="qty" type="number" inputmode="numeric" placeholder="0" min="0" step="1">
                <button class="step" id="plus1">+</button>
                <button class="step" id="plus10">+10</button>
              </div>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="keypadOpen">üî¢ ‡πÅ‡∏õ‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</button>
            </div>
          </div>

          <div class="row">
            <div style="flex: 1;">
              <label>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <input id="noteInput" class="note" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ">
            </div>
          </div>

          <div class="status">
            <div class="sbox">
              <b>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</b>
              <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            </div>
            <div class="sbox">
              <b>üì¶ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</b>
              <span id="stockRemain">-</span>
            </div>
            <div class="sbox">
              <b>üè∑Ô∏è ‡∏ä‡∏∑‡πà‡∏≠ Part</b>
              <span id="partName">-</span>
            </div>
            <div class="sbox">
              <b>üè¢ Customer ‚Ä¢ Location</b>
              <span id="custLoc">-</span>
            </div>
          </div>

          <div class="action-box">
            <div class="action-head">
              <div class="action-title">‚ö° ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô</div>
              <div class="badge">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î</div>
            </div>
            <div class="action-grid">
              <button id="btnIn" class="big in">
                ‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Stock
              </button>
              <button id="btnOut" class="big out">
                üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="inner">
          <div class="section-title">
            <h3>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Part</h3>
            <div class="badge">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          </div>
          
          <div class="scroll">
            <table class="table">
              <thead>
                <tr>
                  <th class="th-datetime">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th class="th-type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th class="th-amount right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th class="th-balance right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                  <th class="th-note note-col">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
              </thead>
              <tbody id="partLogBody">
                <tr>
                  <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="list" id="partLogList"></div>
        </div>
      </div>
    </section>

    <!-- History Tab -->
    <section id="tab-history" class="tab">
      <div class="card">
        <div class="inner">
          <div class="section-title">
            <h3>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
          </div>
          
          <div class="row">
            <div style="flex: 1; min-width: 200px;">
              <label>üè∑Ô∏è Part Number</label>
              <input id="filterPart" class="input" list="partList2" placeholder="‡∏ß‡πà‡∏≤‡∏á = ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
              <datalist id="partList2"></datalist>
            </div>
            <div style="min-width: 140px;">
              <label>üìä ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
              <select id="filterType" class="select">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="in">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option>
                <option value="out">‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>üìÖ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" id="startDate" class="input">
            </div>
            <div>
              <label>üìÖ ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" id="endDate" class="input">
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="quick7">7 ‡∏ß‡∏±‡∏ô</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="quick30">30 ‡∏ß‡∏±‡∏ô</button>
            </div>
          </div>

          <div class="row">
            <button id="btnSearch" class="btn pri">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            <button id="btnMore" class="btn">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            <button id="btnExport" class="btn">üíæ Export CSV</button>
          </div>

          <div id="idxWarn" class="badge" style="display: none; margin: 8px 0; background: rgba(245, 158, 11, 0.2); color: var(--warning); border-color: rgba(245, 158, 11, 0.3);">
            ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ Index ‚Äî ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Part
          </div>

          <div class="scroll">
            <table class="table">
              <thead>
                <tr>
                  <th class="th-datetime">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th class="th-partno">Part Number</th>
                  <th class="th-partname">‡∏ä‡∏∑‡πà‡∏≠ Part</th>
                  <th class="th-type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th class="th-amount right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th class="th-balance right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                  <th class="th-note note-col">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 40px;">
                    ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="list" id="historyList"></div>
          <div id="histStatus" class="badge" style="margin-top: 16px;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>
        </div>
      </div>
    </section>

    <!-- Settings Tab -->
    <section id="tab-settings" class="tab">
      <div class="card">
        <div class="inner">
          <div class="section-title">
            <h3>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
          </div>
          
          <div class="row">
            <button class="btn" id="toggleTheme2">üé® ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á</button>
            <button class="btn" id="reloadParts">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Part</button>
          </div>

          <div class="row">
            <button class="btn" id="createSampleData">üì¶ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
            <button class="btn" id="clearAllData">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>

          <div class="row">
            <button class="btn" id="exportBackup">üíæ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <input type="file" id="importFile" accept=".json" style="display: none;">
            <button class="btn" id="importBackup">üìÅ Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          </div>
          
          <div class="status">
            <div class="sbox">
              <b>üîê ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</b>
              <span id="connectionStatus">Firebase Firestore</span>
            </div>
            <div class="sbox">
              <b>üì± ‡∏£‡∏∏‡πà‡∏ô‡πÅ‡∏≠‡∏õ</b>
              <span>WIPFG v3.0</span>
            </div>
            <div class="sbox">
              <b>üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Parts</b>
              <span id="totalParts">-</span>
            </div>
            <div class="sbox">
              <b>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b>
              <span id="totalLogs">-</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Enhanced Keypad Modal -->
  <div id="keypad" class="modal-overlay keypad-overlay">
    <div class="modal-content keypad-content">
      <div class="modal-header">
        <div class="modal-title">üî¢ ‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
        <button id="padClose" class="btn">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="keypad-grid">
        <button class="keypad-btn">1</button>
        <button class="keypad-btn">2</button>
        <button class="keypad-btn">3</button>
        <button class="keypad-btn">4</button>
        <button class="keypad-btn">5</button>
        <button class="keypad-btn">6</button>
        <button class="keypad-btn">7</button>
        <button class="keypad-btn">8</button>
        <button class="keypad-btn">9</button>
        <button class="keypad-btn">C</button>
        <button class="keypad-btn">0</button>
        <button class="keypad-btn">‚Üê</button>
      </div>
    </div>
  </div>

  <!-- Enhanced Scanner Modal -->
  <div id="scanModal" class="modal-overlay">
    <div class="scanner-content">
      <video id="video" class="scanner-video"></video>
      <div class="scanner-overlay"></div>
      <button id="closeScan" class="scanner-close">‚úñ ‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toasts" class="toast-container"></div>

  <script>
    // ===== Core Utilities =====
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => [...document.querySelectorAll(s)];
    const toasts = $("#toasts");

    // Enhanced Toast System
    
    // Gate haptics until after first user gesture (avoid browser block)
    let __USER_GESTURE__ = false;
    ['pointerdown','touchstart','keydown','click'].forEach(evt => {
      window.addEventListener(evt, () => { __USER_GESTURE__ = true; }, { once: true, passive: true });
    });
function toast(message, isSuccess = true) {
      const toast = document.createElement("div");
      toast.className = `toast ${isSuccess ? 'success' : 'error'}`;
      toast.textContent = message;
      toasts.appendChild(toast);
      
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
      
      if (navigator.vibrate && __USER_GESTURE__) {
        try { navigator.vibrate(isSuccess ? [50] : [100, 50, 100]); } catch(e){}
      }
    }

    // Date Formatting
    const formatDate = (date) => {
      const pad = n => String(n).padStart(2, '0');
      return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    };

    // Enhanced Theme Management
    const themeToggle = $("#themeToggle");
    const root = document.documentElement;
    const savedTheme = localStorage.getItem("wipfg-theme") || "dark";
    root.setAttribute("data-theme", savedTheme);

    function syncTheme() {
      const isDark = root.getAttribute("data-theme") === "dark";
      themeToggle.textContent = isDark ? "‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á" : "üåô ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î";
    }

    themeToggle.addEventListener("click", () => {
      const currentTheme = root.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      
      root.setAttribute("data-theme", newTheme);
      localStorage.setItem("wipfg-theme", newTheme);
      syncTheme();
      
      document.body.style.transition = 'all 0.3s ease';
      setTimeout(() => {
        document.body.style.transition = '';
      }, 300);
    });

    $("#toggleTheme2").addEventListener("click", () => themeToggle.click());
    syncTheme();

    // Mobile Toggle
    const mobileToggle = $("#mobileToggle");
    const savedMobile = localStorage.getItem("wipfg-force-mobile") === "1";
    if (savedMobile) {
      document.body.classList.add("force-mobile");
      mobileToggle.checked = true;
    }

    mobileToggle.addEventListener("change", () => {
      if (mobileToggle.checked) {
        document.body.classList.add("force-mobile");
        localStorage.setItem("wipfg-force-mobile", "1");
      } else {
        document.body.classList.remove("force-mobile");
        localStorage.setItem("wipfg-force-mobile", "0");
      }
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Enhanced Tab Navigation
    function activate(id) {
      $$(".tab").forEach(tab => {
        tab.classList.remove("active");
      });
      $("#" + id).classList.add("active");
      
      $$(".segbtn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.nav === id);
      });
      
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    $$(".segbtn").forEach(btn => {
      btn.addEventListener("click", () => {
        btn.classList.add("loading");
        setTimeout(() => {
          btn.classList.remove("loading");
          activate(btn.dataset.nav);
        }, 150);
      });
    });

    // Enhanced Scanner
    const scanBtn = $("#scanBtn");
    const scanModal = $("#scanModal");
    const video = $("#video");
    const closeScan = $("#closeScan");
    let codeReader = null;

    async function startScanner() {
      try {
        if (!navigator.mediaDevices?.getUserMedia) {
          toast("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á", false);
          return;
        }

        scanBtn.classList.add("loading");
        
        if (!codeReader) {
          codeReader = new ZXing.BrowserMultiFormatReader();
        }
        
        scanModal.style.display = "flex";
        let deviceId = undefined;
        if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const cams = devices.filter(d => d.kind === 'videoinput');
          const back = cams.find(d => /back|rear|environment/i.test(d.label || ''));
          deviceId = (back || cams[0])?.deviceId;
        }

        await codeReader.decodeFromVideoDevice(deviceId, video, (result, error) => {
          if (result) {
            const scannedText = result.getText();
            $("#partNoInput").value = scannedText;
            $("#partNoInput").classList.add("success-anim");
            
            setTimeout(() => $("#partNoInput").classList.remove("success-anim"), 600);
            selectPart(scannedText);
            stopScanner();
            toast("‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + scannedText);
          }
        });
        
        scanBtn.classList.remove("loading");
      } catch (error) {
        console.error(error);
        scanBtn.classList.remove("loading");
        toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false);
        stopScanner();
      }
    }

    function stopScanner() {
      try {
        if (codeReader) {
          codeReader.reset();
        }
      } catch (e) {
        console.error("Error stopping scanner:", e);
      }
      scanModal.style.display = "none";
    }

    scanBtn.addEventListener("click", startScanner);
    closeScan.addEventListener("click", stopScanner);


    // === Back & Home Navigation (added) ===
    const btnBackNav = $("#btnBackNav");
    const btnHomeNav = $("#btnHomeNav");

    if (btnBackNav) {
      btnBackNav.addEventListener("click", (e) => {
        e.preventDefault();
        // Go back if possible, otherwise go to Home
        if (document.referrer && window.history.length > 1) {
          history.back();
        } else {
          // Change this path if your homepage is different (e.g., "/wip/")
          window.location.href = "wip.html";
        }
      });
    }

    if (btnHomeNav) {
      btnHomeNav.addEventListener("click", (e) => {
        e.preventDefault();
        // Change this path if your homepage is different (e.g., "/wip/")
        window.location.href = "index.html";
      });
    }


    // Enhanced Keypad
    const keypad = $("#keypad");
    const keypadOpen = $("#keypadOpen");
    const padClose = $("#padClose");
    const qtyInput = $("#qtyInput");

    keypadOpen.addEventListener("click", () => {
      keypad.style.display = "flex";
    });

    padClose.addEventListener("click", () => {
      keypad.style.display = "none";
    });

    $$(".keypad-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const value = btn.textContent.trim();
        const currentValue = qtyInput.value || "";
        
        if (value === "C") {
          qtyInput.value = "";
        } else if (value === "‚Üê") {
          qtyInput.value = currentValue.slice(0, -1);
        } else {
          qtyInput.value = currentValue + value;
        }
        
        btn.classList.add("success-anim");
        setTimeout(() => btn.classList.remove("success-anim"), 300);
      });
    });

    // Close modals on outside click
    [keypad, scanModal].forEach(modal => {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
          if (modal === scanModal) stopScanner();
        }
      });
    });

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDdHCxweV-gNsJadwvPat7itPHtqPjI09c",
      authDomain: "fg-realtime.firebaseapp.com",
      projectId: "fg-realtime",
      storageBucket: "fg-realtime.firebasestorage.app",
      messagingSenderId: "868246817558",
      appId: "1:868246817558:web:92ac8cf055e57fc7f0de37"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
// === Catalog helpers: remember Part No even after stock doc is deleted ===
const CATALOG = db.collection('/rooms/wipfg/catalog');
function idFromPartNo(pn) {
  return String(pn || '').trim().replace(/[./#[\]$]/g, '_').slice(0, 150);
}
async function ensureCatalog(partNo, partName) {
  if (!partNo) return;
  try {
    await CATALOG.doc(idFromPartNo(partNo)).set(
      { partNo: String(partNo), partName: partName || null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
      { merge: true }
    );
  } catch (e) { /* silent */ }
}

    const auth = firebase.auth();

    // Main Application Variables
    const partNoInput = $("#partNoInput");
    const partList = $("#partList");
    const noteInput = $("#noteInput");
    const statusText = $("#statusText");
    const stockRemain = $("#stockRemain");
    const partName = $("#partName");
    const custLoc = $("#custLoc");
    const minus1 = $("#minus1");
    const plus1 = $("#plus1");
    const plus10 = $("#plus10");
    const btnIn = $("#btnIn");
    const btnOut = $("#btnOut");
    const partLogBody = $("#partLogBody");
    const partLogList = $("#partLogList");

    let currentRef = null;
let currentPartDocs = [];
let unsubPartsQuery = null;
window.currentPartDocs = currentPartDocs;
    let unsubDoc = null;
    let unsubLogs = null;

    // Enhanced Quantity Controls
    minus1.addEventListener('click', () => {
      const current = parseInt(qtyInput.value || '0') || 0;
      qtyInput.value = Math.max(0, current - 1);
      minus1.classList.add("success-anim");
      setTimeout(() => minus1.classList.remove("success-anim"), 300);
    });

    plus1.addEventListener('click', () => {
      const current = parseInt(qtyInput.value || '0') || 0;
      qtyInput.value = current + 1;
      plus1.classList.add("success-anim");
      setTimeout(() => plus1.classList.remove("success-anim"), 300);
    });

    plus10.addEventListener('click', () => {
      const current = parseInt(qtyInput.value || '0') || 0;
      qtyInput.value = current + 10;
      plus10.classList.add("success-anim");
      setTimeout(() => plus10.classList.remove("success-anim"), 300);
    });

    // Enhanced Part Selection
    function clearPart() {
      currentRef = null;
      if (unsubDoc) { unsubDoc(); unsubDoc = null; }
      if (unsubLogs) { unsubLogs(); unsubLogs = null; }
      
      statusText.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part";
      stockRemain.textContent = "-";
      partName.textContent = "-";
      custLoc.textContent = "-";
      
      partLogBody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
          </td>
        </tr>
      `;
      partLogList.innerHTML = "";
    }

    async function loadPartList() {
  try {
    $("#reloadParts").classList.add("loading");
    const [partsSnap, catalogSnap] = await Promise.all([
      db.collection("/rooms/wipfg/parts").orderBy("partNo").limit(1200).get(),
      db.collection("/rooms/wipfg/catalog").orderBy("partNo").limit(2000).get()
    ]);
    const setPN = new Set();
    partsSnap.docs.forEach(doc => { const pn = doc.data()?.partNo; if (pn) setPN.add(String(pn)); });
    catalogSnap.docs.forEach(doc => { const pn = doc.data()?.partNo; if (pn) setPN.add(String(pn)); });
    const options = [...setPN].sort((a,b)=>a.localeCompare(b,'th'))
      .map(pn => `<option value="${pn.replace(/"/g,'&quot;')}"></option>`).join("");
    partList.innerHTML = options;
    $("#partList2").innerHTML = options;
    toast("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Part ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  } catch (error) {
    console.error(error);
    toast("‡πÇ‡∏´‡∏•‡∏î Part ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false);
  } finally {
    $("#reloadParts").classList.remove("loading");
  }
}

    $("#reloadParts").addEventListener("click", loadPartList);

    function addPartLogRow(rowData) {
      // Table row
      const row = document.createElement("tr");
      const typeClass = rowData.type === 'in' ? 'success' : 'error';
      const typeText = rowData.type === 'in' ? '‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : 'üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å';
      const amountText = `${rowData.type === 'in' ? '+' : '-'}${Number(rowData.amount || 0).toLocaleString()}`;
      
      row.innerHTML = `
        <td style="font-size: 12px;">${formatDate(rowData.ts)}</td>
        <td>
          <span style="padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600; background: var(--${typeClass}); color: white;">
            ${typeText}
          </span>
        </td>
        <td style="text-align: right; font-weight: 600; color: var(--${typeClass});">
          ${amountText}
        </td>
        <td style="text-align: right; font-weight: 700;">
          ${Number(rowData.balance || 0).toLocaleString()}
        </td>
        <td class="note-col" style="color: var(--text-muted);">${rowData.note || ''}</td>
      `;
      
      partLogBody.appendChild(row);

      // List item for mobile
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="item-top">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span>${rowData.type === 'in' ? '‚úÖ' : 'üì§'}</span>
            <span>${rowData.type === 'in' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å'}</span>
          </div>
          <div style="font-size: 12px;">${formatDate(rowData.ts)}</div>
        </div>
        <div class="item-sub">
          <div style="color: var(--${typeClass}); font-weight: 600;">
            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${amountText}</b>
          </div>
          <div style="font-weight: 700;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <b>${Number(rowData.balance || 0).toLocaleString()}</b></div>
          ${rowData.note ? `<div>üìù ${rowData.note}</div>` : ''}
        </div>
      `;
      
      partLogList.appendChild(item);
    }

    
async function selectPart(partNo) {
  clearPart();
  partNoInput.classList.add("loading");
  try {
    const coll = db.collection("/rooms/wipfg/parts");
    const q = coll.where("partNo", "==", partNo);
    statusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î: " + partNo;

    unsubPartsQuery = q.onSnapshot(async (snap) => {
      currentPartDocs = [];
      window.currentPartDocs = currentPartDocs;

      if (snap.empty) {
        statusText.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö Part: " + partNo;
        stockRemain.textContent = "0";
        partName.textContent = "-";
        custLoc.textContent = "-";
        partLogBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">
              ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </td>
          </tr>`;
        partLogList.innerHTML = "";
        return;
      }

      let total = 0;
      let anyName = null;
      const pairs = [];
      snap.forEach(doc => {
        const data = doc.data() || {};
        const qty = Number(data.qty ?? data.quantity ?? 0) || 0;
        total += qty;
        anyName = anyName || data.partName || null;
        const pairText = [data.customer || "-", data.location || "-"].join(" ‚Ä¢ ");
        pairs.push({ id: doc.id, ref: doc.ref, qty, text: pairText, customer: data.customer || "-", location: data.location || "-" });
        currentPartDocs.push({ id: doc.id, ref: doc.ref, data });
      });

      const pick = pairs.slice().sort((a,b)=>b.qty - a.qty)[0];
      if (pick) currentRef = pick.ref;

      statusText.textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${partNo} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${pairs.length} Location)`;
      stockRemain.textContent = isFinite(total) ? total.toLocaleString() : "-";
      partName.textContent = anyName || "-";

      if (pairs.length <= 3) {
        custLoc.textContent = pairs.map(p => `${p.text} (${p.qty})`).join(" ‚Ä¢ ");
      } else {
        const head = pairs.slice(0,2).map(p => `${p.text} (${p.qty})`).join(" ‚Ä¢ ");
        const more = pairs.length - 2;
        const restSum = pairs.slice(2).reduce((s,p)=>s+p.qty,0);
        custLoc.textContent = `${head} ‚Ä¢ +${more} locs (${restSum})`;
      }

      if (unsubLogs) { try{unsubLogs()}catch(e){} unsubLogs = null; }
      const logsByDoc = {};
      const unsubbers = [];

      function addRows() {
        const merged = [];
        Object.keys(logsByDoc).forEach(id => { merged.push(...(logsByDoc[id] || [])); });
        merged.sort((a,b)=> b.ts - a.ts);
        partLogBody.innerHTML = "";
        partLogList.innerHTML = "";
        if (!merged.length) {
          partLogBody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
              </td>
            </tr>`;
          return;
        }
        merged.slice(0,100).forEach(addPartLogRow);
      }

      for (const doc of snap.docs) {
        try {
          const u = doc.ref.collection("logs").orderBy("ts","desc").limit(50).onSnapshot(lsnap => {
            const rows = [];
            lsnap.forEach(ldoc => {
              const d = ldoc.data() || {};
              rows.push({
                ts: d.ts?.toDate?.() || new Date(),
                type: d.type || 'in',
                amount: d.amount || 0,
                balance: d.balance || 0,
                note: d.note || ''
              });
            });
            logsByDoc[doc.id] = rows;
            addRows();
          });
          unsubbers.push(u);
        } catch(e) {}
      }
      unsubLogs = () => { unsubbers.forEach(fn => { try{fn()}catch(e){} }); };
    });

    partNoInput.classList.add("success-anim");
    setTimeout(()=> partNoInput.classList.remove("success-anim"), 600);
  } catch (error) {
    console.error(error);
    toast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", false);
  } finally {
    partNoInput.classList.remove("loading");
  }
}

    // Part input event listeners
    partNoInput.addEventListener('change', (e) => {
      const value = (e.target.value || '').trim();
      if (value) selectPart(value);
    });

    partNoInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const value = (e.target.value || '').trim();
        if (value) selectPart(value);
      }
    });

    // Enhanced Stock Adjustment
    async function adjustStock(type, pickId) {
  const amount = Math.floor(Number(qtyInput.value));
  if (!isFinite(amount) || amount <= 0) {
    toast("‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô > 0", false);
    qtyInput.classList.add("error-anim");
    setTimeout(() => qtyInput.classList.remove("error-anim"), 400);
    return;
  }
  const targetBtn = type === 'in' ? btnIn : btnOut;
  targetBtn.classList.add("loading");
  const partNo = (partNoInput.value || '').trim();

  // Global BIG popup at start of OUT (extra-safe)
  try {
    if (type === 'out') {
      let txt = '';
      const docs = (window.currentPartDocs || []);
      const selId = pickId || null;
      if (selId) {
        const sel = docs.find(d => d.id === selId);
        txt = sel?.data?.location || txt;
      }
      if (!txt) {
        const checked = document.querySelector('input[name="locPick"]:checked');
        if (checked) {
          const row = checked.closest('label');
          txt = (row?.dataset?.location) || row?.querySelector('.loc-name')?.textContent || txt;
        }
      }
      if (!txt && docs.length === 1) txt = docs[0]?.data?.location || txt;
      if (typeof showOutPopupGlobal === 'function') showOutPopupGlobal(txt || '...');
    }
  } catch(e) {}

  
  // Fail-safe: always show BIG popup on OUT (safe refs, no undefined vars)
  try {
    if (type === 'out') {
      let outLocText = '';
      const docs = (window.currentPartDocs || []);
      // 1) Use pickId passed in (most reliable)
      const selId = pickId || null;
      if (selId) {
        const sel = docs.find(d => d.id === selId);
        if (sel && sel.data && sel.data.location) outLocText = sel.data.location;
      }
      // 2) If not found, read from checked radio in modal
      if (!outLocText) {
        const checked = document.querySelector('input[name="locPick"]:checked');
        if (checked) {
          const row = checked.closest('label');
          if (row) {
            outLocText = (row.dataset && row.dataset.location) || (row.querySelector('.loc-name')?.textContent) || '';
          }
        }
      }
      // 3) If still empty and‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      if (!outLocText && docs.length === 1) {
        outLocText = docs[0]?.data?.location || '';
      }
      if (outLocText && typeof showOutPopup === 'function') { showOutPopup(outLocText); }
    }
  } catch(e) { console.warn('popup fail-safe error', e); }
// Choose reference to update strictly by pickId when provided
  let refToUse = currentRef;
  if (pickId && Array.isArray(window.currentPartDocs)) {
    const chosen = window.currentPartDocs.find(d => d.id === pickId);
    if (chosen && chosen.ref) refToUse = chosen.ref;
  }

  // If user chose to create a NEW location on IN, force new doc
  if (type === 'in' && pickId === '__NEW__') {
    refToUse = null;
  }



  try {
    // Case: Receive without existing doc -> create new doc
    if (!refToUse) {
      if (type !== 'in') throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part ‡∏Å‡πà‡∏≠‡∏ô");

      // Create new doc under provided Customer/Location from modal
      let customer = window.selectedNewLoc?.customer || '';
      let location = window.selectedNewLoc?.location || '';

      if (!customer || !location) {
        // fallback prompt (rare)
        customer = prompt("Customer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤", "") || "";
        location = prompt("Location ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤", "") || "";
      }
      if (!customer || !location) throw new Error("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ Customer ‡πÅ‡∏•‡∏∞ Location");

      const pName = (partName.textContent || '').trim();
      const coll = db.collection("/rooms/wipfg/parts");
      const newDoc = coll.doc();
      await db.runTransaction(async (transaction) => {
        transaction.set(newDoc, {
          customer, location, partNo: partNo, partName: pName || null,
          qty: amount,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        const logRef = newDoc.collection("logs").doc();
        transaction.set(logRef, {
          type: 'in', amount, balance: amount,
          partNo: partNo, partName: pName || null,
          note: (noteInput.value || '').slice(0,200),
          ts: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      refToUse = newDoc; currentRef = newDoc;
      statusText.textContent = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß: " + partNo;
      await ensureCatalog(partNo, pName);
      toast(`‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ${amount} ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
      qtyInput.value = ""; noteInput.value = "";
      targetBtn.classList.add("success-anim");
      setTimeout(() => targetBtn.classList.remove("success-anim"), 600);
      return;
    }

    // Existing doc: adjust in transaction
    await firebase.firestore().runTransaction(async (transaction) => {
      const docSnapshot = await transaction.get(refToUse);
      if (!docSnapshot.exists) { throw new Error("‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏≤‡∏¢"); }
      const data = docSnapshot.data() || {};
      const currentStock = Number(data.qty ?? data.quantity ?? 0);
      let newStock = currentStock;

      if (type === 'in') {
        newStock = currentStock + amount;
      } else {
        if (currentStock < amount) throw new Error(`‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${currentStock} ‡πÑ‡∏°‡πà‡∏û‡∏≠`);
        newStock = currentStock - amount;
      }

      // Log first
      const logRef = refToUse.collection("logs").doc();
      transaction.set(logRef, {
        type, amount, balance: newStock,
        partNo: data.partNo || partNo || null,
        partName: data.partName || null,
        note: (noteInput.value || '').slice(0,200),
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });

      if (type === 'in' || newStock > 0) {
        transaction.update(refToUse, { qty: newStock, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        return;
      }
      // newStock == 0 => delete document to remove from Location
      transaction.delete(currentRef);
    });

    await ensureCatalog(partNo, document.getElementById('partName')?.textContent || null);
    const actionText = type === 'in' ? '‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : 'üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å';
    toast(`${actionText} ${amount} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    qtyInput.value = ""; noteInput.value = "";
    targetBtn.classList.add("success-anim");
    setTimeout(() => targetBtn.classList.remove("success-anim"), 600);
  } catch (error) {
    console.error(error);
    toast("‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message, false);
    targetBtn.classList.add("error-anim");
    setTimeout(() => targetBtn.classList.remove("error-anim"), 400);
  } finally {
    targetBtn.classList.remove("loading");
  }
}

    btnIn.addEventListener("click", () => adjustStock('in'));
    btnOut.addEventListener("click", () => adjustStock('out'));

    // Keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      if (e.target.matches('input, textarea, select')) return;
      
      if (e.key === "+" || e.key === "=") {
        e.preventDefault();
        adjustStock("in");
      }
      if (e.key === "-" || e.key === "_") {
        e.preventDefault();
        adjustStock("out", selectedDocId);
      }
    });

    // History functionality
    const filterPart = $("#filterPart");
    const filterType = $("#filterType");
    const startDate = $("#startDate");
    const endDate = $("#endDate");
    const btnSearch = $("#btnSearch");
    const btnMore = $("#btnMore");
    const btnExport = $("#btnExport");
    const histStatus = $("#histStatus");
    const idxWarn = $("#idxWarn");
    const historyBody = $("#historyBody");
    const historyList = $("#historyList");

    let lastDoc = null;
    let pending = false;
    let fallback = false;

    // Cache for fallback mode
    let fbCache = [];
    let fbCursor = 0;
    let fbParams = null;

    function addHistoryRow(data) {
      const row = document.createElement("tr");
      const typeClass = data.type === 'in' ? 'success' : 'error';
      const typeText = data.type === 'in' ? '‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : 'üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å';
      const amountText = `${data.type === 'in' ? '+' : '-'}${Number(data.amount || 0).toLocaleString()}`;
      
      row.innerHTML = `
        <td style="font-size: 12px;">${formatDate(data.ts)}</td>
        <td style="font-weight: 600; color: var(--primary);">${data.partNo || '-'}</td>
        <td>${data.partName || ''}</td>
        <td>
          <span style="padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600; background: var(--${typeClass}); color: white;">
            ${typeText}
          </span>
        </td>
        <td style="text-align: right; font-weight: 600; color: var(--${typeClass});">
          ${amountText}
        </td>
        <td style="text-align: right; font-weight: 700;">
          ${Number(data.balance || 0).toLocaleString()}
        </td>
        <td class="note-col" style="color: var(--text-muted);">${data.note || ''}</td>
      `;
      
      historyBody.appendChild(row);

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="item-top">
          <div style="font-weight: 600;">${data.partNo || '-'} ‚Äî ${data.partName || ''}</div>
          <div style="font-size: 12px;">${formatDate(data.ts)}</div>
        </div>
        <div class="item-sub">
          <div>${data.type === 'in' ? '‚úÖ' : 'üì§'} ${data.type === 'in' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å'}</div>
          <div style="color: var(--${typeClass}); font-weight: 600;">
            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${amountText}</b>
          </div>
          <div style="font-weight: 700;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <b>${Number(data.balance || 0).toLocaleString()}</b></div>
          ${data.note ? `<div>üìù ${data.note}</div>` : ''}
        </div>
      `;
      
      historyList.appendChild(item);
    }

    function endOfDay(date) {
      const endDate = new Date(date);
      endDate.setHours(23, 59, 59, 999);
      return endDate;
    }

    function parseDateInput(input) {
      if (!input.value) return null;
      const date = new Date(input.value + 'T00:00:00');
      return isNaN(date) ? null : date;
    }

    // Quick date buttons
    $("#quick7").addEventListener("click", () => {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 6);
      startDate.value = start.toISOString().slice(0, 10);
      endDate.value = end.toISOString().slice(0, 10);
    });

    $("#quick30").addEventListener("click", () => {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 29);
      startDate.value = start.toISOString().slice(0, 10);
      endDate.value = end.toISOString().slice(0, 10);
    });

    async function searchHistory(reset = true) {
      if (pending) return;
      pending = true;
      histStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
      
      try {
        const partNo = (filterPart.value || '').trim();
        const type = filterType.value || '';
        const startDateValue = parseDateInput(startDate);
        const endDateValue = parseDateInput(endDate);

        if (!fallback) {
          // Normal path (requires Index)
          let query = db.collectionGroup("logs").orderBy("ts", "desc");
          
          if (partNo) query = query.where("partNo", "==", partNo);
          if (startDateValue) query = query.where("ts", ">=", startDateValue);
          if (endDateValue) query = query.where("ts", "<=", endOfDay(endDateValue));
          if (reset) {
            historyBody.innerHTML = '';
            historyList.innerHTML = '';
            lastDoc = null;
          }
          if (lastDoc) query = query.startAfter(lastDoc);
          
          query = query.limit(100);
          const snapshot = await query.get();
          
          if (snapshot.empty) {
            histStatus.textContent = reset ? "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" : "‡∏´‡∏°‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            pending = false;
            return;
          }

          const jobs = [];
          snapshot.forEach(doc => {
            const data = doc.data() || {};
            const row = {
              ts: data.ts?.toDate?.() || new Date(),
              type: data.type || 'in',
              amount: data.amount || 0,
              balance: data.balance || 0,
              partNo: data.partNo || null,
              partName: data.partName || null,
              note: data.note || null
            };
            
            if (type && row.type !== type) return;
            
            if (!row.partNo || !row.partName) {
              const parent = doc.ref.parent.parent;
              if (parent) {
                jobs.push(parent.get().then(parentDoc => {
                  const parentData = parentDoc.data() || {};
                  row.partNo = row.partNo || parentData.partNo || null;
                  row.partName = row.partName || parentData.partName || null;
                  addHistoryRow(row);
                }));
              }
            } else {
              addHistoryRow(row);
            }
          });
          
          await Promise.all(jobs);
          lastDoc = snapshot.docs[snapshot.docs.length - 1];
          histStatus.textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß";
          
        } else {
          // Fallback mode (no Index) ‚Äî requires Part number
          idxWarn.style.display = 'inline-block';
          if (!partNo) {
            histStatus.textContent = "‡πÇ‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Part Number";
            pending = false;
            return;
          }

          const key = JSON.stringify({
            partNo,
            type,
            start: startDateValue?.toISOString() || null,
            end: endDateValue ? endOfDay(endDateValue).toISOString() : null
          });
          
          if (reset || key !== fbParams) {
            fbParams = key;
            fbCache = [];
            fbCursor = 0;
            historyBody.innerHTML = '';
            historyList.innerHTML = '';
            
            const parts = await db.collection("/rooms/wipfg/parts")
              .where("partNo", "==", partNo)
              .limit(5)
              .get();
            
            if (parts.empty) {
              histStatus.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö Part";
              pending = false;
              return;
            }

            const allRows = [];
            for (const doc of parts.docs) {
              let query = doc.ref.collection("logs").orderBy("ts", "desc");
              if (startDateValue) query = query.where("ts", ">=", startDateValue);
              if (endDateValue) query = query.where("ts", "<=", endOfDay(endDateValue));
              
              const snapshot = await query.limit(1000).get();
              snapshot.forEach(logDoc => {
                const data = logDoc.data() || {};
                const row = {
                  ts: data.ts?.toDate?.() || new Date(),
                  type: data.type || 'in',
                  amount: data.amount || 0,
                  balance: data.balance || 0,
                  partNo: partNo,
                  partName: (doc.data()?.partName) || '',
                  note: data.note || ''
                };
                allRows.push(row);
              });
            }
            
            fbCache = allRows
              .filter(row => !type || row.type === type)
              .sort((a, b) => b.ts - a.ts);
          }
          
          const slice = fbCache.slice(fbCursor, fbCursor + 100);
          slice.forEach(addHistoryRow);
          fbCursor += slice.length;
          
          histStatus.textContent = slice.length ? 
            `‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏™‡∏î‡∏á ${fbCursor}/${fbCache.length})` : "‡∏´‡∏°‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        }
      } catch (error) {
        console.error(error);
        if (String(error.message || '').includes('index') && !fallback) {
          fallback = true;
          idxWarn.style.display = 'inline-block';
          histStatus.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏î‡∏±‡∏ä‡∏ô‡∏µ ‚Äî ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß';
          await searchHistory(reset);
        } else {
          histStatus.textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
        }
      } finally {
        pending = false;
      }
    }

    btnSearch.addEventListener("click", () => searchHistory(true));
    btnMore.addEventListener("click", () => searchHistory(false));

    // Export functionality
    btnExport.addEventListener("click", () => {
      const rows = [];
      const headers = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "Part Number", "‡∏ä‡∏∑‡πà‡∏≠ Part", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"];
      rows.push(headers.join(","));
      
      $$("#historyBody tr").forEach(row => {
        const cells = [...row.querySelectorAll("td")].map(cell => {
          let text = cell.textContent.trim();
          text = text.replace(/"/g, '""');
          if (text.includes(",") || text.includes('"') || text.includes("\n")) {
            text = `"${text}"`;
          }
          return text;
        });
        
        if (cells.length > 1) {
          rows.push(cells.join(","));
        }
      });
      
      if (rows.length <= 1) {
        toast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export", false);
        return;
      }
      
      const csvContent = "\uFEFF" + rows.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      
      link.setAttribute("href", url);
      link.setAttribute("download", `WIPFG_History_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toast("Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    });

    // Initialize the application
    async function initializeApp() {
      try {
        statusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
        await auth.signInAnonymously();
        
        auth.onAuthStateChanged(user => {
          const isAuthenticated = !!user;
          $("#connectionStatus").textContent = isAuthenticated ? "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
          statusText.textContent = isAuthenticated ? "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part" : "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
          if (isAuthenticated) {
            loadPartList();
            updateDatabaseStats();
          }
        });
        
        // Set initial dates
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        startDate.value = weekAgo.toISOString().split('T')[0];
        endDate.value = now.toISOString().split('T')[0];
        
      } catch (error) {
        console.error(error);
        toast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false);
      }
    }

    // Database Management Functions
    const samplePartsData = [
      {
        partNo: "ABC-001",
        partName: "Motor Assembly 12V",
        qty: 150,
        customer: "Toyota Motor",
        location: "Warehouse A"
      },
      {
        partNo: "XYZ-002", 
        partName: "Hydraulic Pump",
        qty: 75,
        customer: "Honda",
        location: "Warehouse B"
      },
      {
        partNo: "DEF-003",
        partName: "Control Unit ECU",
        qty: 200,
        customer: "Nissan",
        location: "Warehouse A"
      },
      {
        partNo: "GHI-004",
        partName: "Brake Pad Set",
        qty: 300,
        customer: "Mazda",
        location: "Warehouse C"
      },
      {
        partNo: "JKL-005",
        partName: "Air Filter Element",
        qty: 500,
        customer: "Mitsubishi",
        location: "Warehouse B"
      },
      {
        partNo: "MNO-006",
        partName: "Fuel Injection System",
        qty: 80,
        customer: "Isuzu",
        location: "Warehouse A"
      },
      {
        partNo: "PQR-007",
        partName: "Transmission Gear",
        qty: 120,
        customer: "Suzuki",
        location: "Warehouse C"
      },
      {
        partNo: "STU-008",
        partName: "LED Headlight Module",
        qty: 250,
        customer: "Toyota Motor",
        location: "Warehouse B"
      }
    ];

    async function createSampleData() {
      try {
        $("#createSampleData").classList.add("loading");
        
        const batch = db.batch();
        
        for (const part of samplePartsData) {
          const partRef = db.collection("/rooms/wipfg/parts").doc();
          batch.set(partRef, {
            ...part,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Create some sample log entries
          const logEntries = [
            {
              type: "in",
              amount: Math.floor(part.qty * 0.6),
              balance: Math.floor(part.qty * 0.6),
              partNo: part.partNo,
              partName: part.partName,
              note: "Initial stock",
              ts: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000)
            },
            {
              type: "in", 
              amount: Math.floor(part.qty * 0.4),
              balance: part.qty,
              partNo: part.partNo,
              partName: part.partName,
              note: "Additional supply",
              ts: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000)
            }
          ];
          
          logEntries.forEach(logEntry => {
            const logRef = partRef.collection("logs").doc();
            batch.set(logRef, {
              ...logEntry,
              ts: firebase.firestore.Timestamp.fromDate(logEntry.ts)
            });
          });
        }
        
        await batch.commit();
        
        toast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        await loadPartList();
        await updateDatabaseStats();
        
      } catch (error) {
        console.error(error);
        toast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message, false);
      } finally {
        $("#createSampleData").classList.remove("loading");
      }
    }

    async function clearAllData() {
      if (!confirm("‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ\n\n‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?")) {
        return;
      }
      
      if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£")) {
        return;
      }
      
      try {
        $("#clearAllData").classList.add("loading");
        
        // Get all parts
        const partsSnapshot = await db.collection("/rooms/wipfg/parts").get();
        const batch = db.batch();
        
        // Delete all parts and their logs
        for (const partDoc of partsSnapshot.docs) {
          // Delete all logs first
          const logsSnapshot = await partDoc.ref.collection("logs").get();
          logsSnapshot.docs.forEach(logDoc => {
            batch.delete(logDoc.ref);
          });
          
          // Delete the part document
          batch.delete(partDoc.ref);
        }
        
        await batch.commit();
        
        toast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        clearPart();
        partList.innerHTML = "";
        $("#partList2").innerHTML = "";
        await updateDatabaseStats();
        
      } catch (error) {
        console.error(error);
        toast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message, false);
      } finally {
        $("#clearAllData").classList.remove("loading");
      }
    }

    async function exportBackup() {
      try {
        $("#exportBackup").classList.add("loading");
        
        const backup = {
          timestamp: new Date().toISOString(),
          version: "3.0",
          parts: []
        };
        
        const partsSnapshot = await db.collection("/rooms/wipfg/parts").get();
        
        for (const partDoc of partsSnapshot.docs) {
          const partData = partDoc.data();
          const part = {
            id: partDoc.id,
            ...partData,
            logs: []
          };
          
          // Get logs for this part
          const logsSnapshot = await partDoc.ref.collection("logs").orderBy("ts", "desc").get();
          logsSnapshot.docs.forEach(logDoc => {
            const logData = logDoc.data();
            part.logs.push({
              id: logDoc.id,
              ...logData,
              ts: logData.ts?.toDate?.()?.toISOString() || null
            });
          });
          
          backup.parts.push(part);
        }
        
        const jsonData = JSON.stringify(backup, null, 2);
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        link.href = url;
        link.download = `WIPFG_Backup_${new Date().toISOString().split('T')[0]}.json`;
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        toast("Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        
      } catch (error) {
        console.error(error);
        toast("Export ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message, false);
      } finally {
        $("#exportBackup").classList.remove("loading");
      }
    }

    async function importBackup(fileData) {
      try {
        $("#importBackup").classList.add("loading");
        
        const backup = JSON.parse(fileData);
        
        if (!backup.parts || !Array.isArray(backup.parts)) {
          throw new Error("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }
        
        const batch = db.batch();
        
        for (const part of backup.parts) {
          const { id, logs, createdAt, updatedAt, ...partData } = part;
          const partRef = db.collection("/rooms/wipfg/parts").doc();
          
          batch.set(partRef, {
            ...partData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Import logs
          if (logs && Array.isArray(logs)) {
            logs.forEach(log => {
              const { id: logId, ts, ...logData } = log;
              const logRef = partRef.collection("logs").doc();
              batch.set(logRef, {
                ...logData,
                ts: ts ? firebase.firestore.Timestamp.fromDate(new Date(ts)) : firebase.firestore.FieldValue.serverTimestamp()
              });
            });
          }
        }
        
        await batch.commit();
        
        toast(`Import ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${backup.parts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        await loadPartList();
        await updateDatabaseStats();
        
      } catch (error) {
        console.error(error);
        toast("Import ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message, false);
      } finally {
        $("#importBackup").classList.remove("loading");
      }
    }

    async function updateDatabaseStats() {
      try {
        // Count total parts
        const partsSnapshot = await db.collection("/rooms/wipfg/parts").get();
        $("#totalParts").textContent = partsSnapshot.size.toLocaleString();
        
        // Count total logs (estimate from first few parts)
        let totalLogs = 0;
        const sampleParts = partsSnapshot.docs.slice(0, Math.min(10, partsSnapshot.docs.length));
        
        for (const partDoc of sampleParts) {
          const logsSnapshot = await partDoc.ref.collection("logs").get();
          totalLogs += logsSnapshot.size;
        }
        
        // Estimate total logs if we sampled
        if (partsSnapshot.size > 10) {
          totalLogs = Math.round((totalLogs / sampleParts.length) * partsSnapshot.size);
          $("#totalLogs").textContent = "~" + totalLogs.toLocaleString();
        } else {
          $("#totalLogs").textContent = totalLogs.toLocaleString();
        }
        
      } catch (error) {
        console.error(error);
        $("#totalParts").textContent = "Error";
        $("#totalLogs").textContent = "Error";
      }
    }

    // Event Listeners for Database Management
    $("#createSampleData").addEventListener("click", createSampleData);
    $("#clearAllData").addEventListener("click", clearAllData);
    $("#exportBackup").addEventListener("click", exportBackup);
    
    $("#importBackup").addEventListener("click", () => {
      $("#importFile").click();
    });
    
    $("#importFile").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          importBackup(e.target.result);
        };
        reader.readAsText(file);
      }
    });

    // Start the application
    document.addEventListener("DOMContentLoaded", initializeApp);
  </script>


<!-- Location Modal -->
<div id="locModal" class="modal-overlay" aria-modal="true" role="dialog">
  <div class="modal-content" style="max-width: 560px;">
    <div class="modal-header">
      <div class="modal-title">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö (Location)</div>
      <button id="locClose" class="btn" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div style="padding: 24px;">
      <div id="locCustomer" class="loc-sub" style="display:none;"></div>
      <div id="locText" class="loc-big">-</div>
      <div class="loc-sub" id="locHint" style="margin-top:4px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Location ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</div>
      <div id="locOptions" style="margin-top:12px; display:grid; gap:8px;"></div>
      <div style="margin-top: 20px; display: grid; gap: 12px;">
        <button id="locConfirm" class="btn pri big" style="width:100%;" type="button">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</button>
        <button id="locCancel" class="btn" style="width:100%;" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>
</div>



<script>

(function(){
  const $ = (s)=>document.querySelector(s);

  const locModal = $("#locModal");
  const locText = $("#locText");
  const locHint = $("#locHint");
  const locOptions = $("#locOptions");
  const locConfirm = $("#locConfirm");
  const locClose = $("#locClose");
  const locCancel = $("#locCancel");

  let selectedDocId = null;
  let actionType = "out"; // 'in' or 'out'
  window.selectedNewLoc = null;

  function buildNewLocCard() {
    const wrap = document.createElement("div");
    wrap.style.display = "grid";
    wrap.style.gap = "10px";
    wrap.style.padding = "12px";
    wrap.style.border = "1px dashed var(--border)";
    wrap.style.borderRadius = "12px";
    wrap.style.background = "var(--panel)";

    const head = document.createElement("div");
    head.style.display = "flex";
    head.style.alignItems = "center";
    head.style.gap = "10px";

    const radio = document.createElement("input");
    radio.type = "radio";
    radio.name = "locPick";
    radio.value = "__NEW__";
    radio.addEventListener("change", ()=> { selectedDocId="__NEW__"; });

    const title = document.createElement("b");
    title.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Location ‡πÉ‡∏´‡∏°‡πà";

    head.appendChild(radio);
    head.appendChild(title);

    const grid = document.createElement("div");
    grid.style.display = "grid";
    grid.style.gap = "8px";
    grid.style.gridTemplateColumns = "1fr 1fr";

    const inCust = document.createElement("input");
    inCust.type = "text";
    inCust.placeholder = "Customer";
    inCust.id = "newLocCustomer";
    inCust.className = "input";

    const inLoc = document.createElement("input");
    inLoc.type = "text";
    inLoc.placeholder = "Location";
    inLoc.id = "newLocLocation";
    inLoc.className = "input";

    grid.appendChild(inCust);
    grid.appendChild(inLoc);

    wrap.appendChild(head);
    wrap.appendChild(grid);

    return wrap;
  }

  function openModal(type){
    actionType = type || "out";
    // Dynamic confirm button label
    if (locConfirm) { locConfirm.textContent = (actionType === 'in') ? '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å'; }
    const partNo = (document.getElementById('partNoInput')?.value || '').trim();
    const docs = (window.currentPartDocs || []).slice();

    locOptions.innerHTML = "";
    window.selectedNewLoc = null;
    selectedDocId = null;

    // When IN and no docs yet, we still allow creating new
    if (!partNo) {
      if (window.toast) toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part ‡∏Å‡πà‡∏≠‡∏ô", false);
      return;
    }

    // Sort existing docs by qty desc and render as choices
    if (docs.length) {
      docs.sort((a,b)=> (Number(b.data?.qty ?? 0)) - (Number(a.data?.qty ?? 0)));
      docs.forEach(d => {
        const qty = Number(d.data?.qty ?? d.data?.quantity ?? 0) || 0;
        const cust = d.data?.customer || "-";
        const loc  = d.data?.location || "-";
        const row = document.createElement("label");
        row.style.display = "grid";
        row.style.gridTemplateColumns = "24px 1fr auto";
        row.style.alignItems = "center";
        row.style.gap = "10px";
        row.style.padding = "10px 12px";
        row.style.border = "1px solid var(--border)";
        row.style.borderRadius = "12px";
        row.style.background = "var(--panel)";
        row.style.cursor = "pointer";

        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "locPick";
        radio.value = d.id;
        radio.addEventListener("change", ()=> { selectedDocId = d.id; });

        const info = document.createElement("div");
        info.innerHTML = `<b>${cust} ‚Ä¢ ${loc}</b><div class="loc-sub" style="margin-top:2px;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${qty.toLocaleString()}</div>`;

        const mark = document.createElement("div");
        mark.textContent = actionType === "in" ? "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" : "‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å";
        mark.className = "badge";

        row.appendChild(radio);
        row.appendChild(info);
        row.appendChild(mark);
        locOptions.appendChild(row);
      });
    }

    // For IN: allow "new location"
    if (actionType === "in") {
      const card = buildNewLocCard();
      locOptions.appendChild(card);
    }

    // Preselect a sensible default
    if (docs.length === 1 && actionType === "out") {
      selectedDocId = docs[0].id;
      const first = locOptions.querySelector("input[type=radio]");
      if (first) first.checked = true;
    }

    locText.textContent = partNo;
    locHint.textContent = actionType === "in" ? "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° Location ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" : "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Location ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å";
    locModal.style.display = "flex";
    try { if (navigator.vibrate) navigator.vibrate([40,70,40]); } catch(e){}
  }

  function closeModal(){ if(locModal) locModal.style.display = "none"; }

  function bindButtons(){
    // Bind OUT button
    const outBtn = Array.from(document.querySelectorAll("button, .btn, [role='button']"))
      .find(b => /‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å/.test(b.textContent||""));
    if (outBtn) {
      const clone = outBtn.cloneNode(true);
      if (outBtn.id) clone.id = outBtn.id;
      outBtn.parentNode.replaceChild(clone, outBtn);
      clone.addEventListener("click", (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); openModal("out"); }, true);
    }

    // Bind IN button
    const inBtn = Array.from(document.querySelectorAll("button, .btn, [role='button']"))
      .find(b => /‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤/.test(b.textContent||""));
    if (inBtn) {
      const clone = inBtn.cloneNode(true);
      if (inBtn.id) clone.id = inBtn.id;
      inBtn.parentNode.replaceChild(clone, inBtn);
      clone.addEventListener("click", (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); openModal("in"); }, true);
    }
  }

  document.addEventListener("DOMContentLoaded", function(){
    bindButtons();

    if (locConfirm) {
      locConfirm.addEventListener("click", function(){
        const docs = (window.currentPartDocs || []);
        if (selectedDocId === "__NEW__" && actionType === "in") {
          const c = document.getElementById("newLocCustomer")?.value?.trim() || "";
          const l = document.getElementById("newLocLocation")?.value?.trim() || "";
          if (!c || !l) { if (window.toast) toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Customer ‡πÅ‡∏•‡∏∞ Location", false); return; }
          window.selectedNewLoc = { customer: c, location: l };
        }
        const pick = selectedDocId ? selectedDocId : (docs.length === 1 ? docs[0].id : null);
        if (!pick && actionType === "out") { if (window.toast) toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Location", false); return; }
        
        // Show BIG popup of selected OUT location (robust)
        let __outLocForPopup = "";
        try {
          if (actionType === "out") {
            // Priority: checked radio row dataset or .loc-name
            const checked = document.querySelector('input[name="locPick"]:checked');
            if (checked) {
              const row = checked.closest('label');
              if (row) {
                __outLocForPopup = (row.dataset && row.dataset.location) || (row.querySelector('.loc-name')?.textContent) || "";
              }
            }
            // Fallback: selectedDocId -> docs
            if (!__outLocForPopup) {
              const docs = (window.currentPartDocs || []);
              if (selectedDocId && selectedDocId !== "__NEW__") {
                const sel = docs.find(d => d.id === selectedDocId);
                __outLocForPopup = sel?.data?.location || "";
              } else if (docs.length === 1) {
                __outLocForPopup = docs[0]?.data?.location || "";
              }
            }
            // Show immediately
            if (__outLocForPopup && typeof showOutPopup === "function") { showOutPopup(__outLocForPopup); }
            // And again after the modal fully closes (some themes animate)
            setTimeout(()=>{ if (__outLocForPopup && typeof showOutPopup === "function") showOutPopup(__outLocForPopup); }, 220);
            // Tiny toast fallback
            if (__outLocForPopup && typeof showOutToast === "function") { showOutToast("‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å: " + __outLocForPopup); }
          }
        } catch(e){ console.warn(e); }
    
        closeModal();
        if (typeof adjustStock === "function") { try{ adjustStock(actionType, pick); }catch(e){ console.error(e); } }
      });
    }
    [locClose, locCancel].forEach(btn=>{ if(btn){ btn.addEventListener("click", closeModal); }});
    if (locModal) {
      locModal.addEventListener("click", (e)=>{ if(e.target === locModal) closeModal(); });
    }
  });
})();
</script>




  <!-- Receive Modal -->
  <div id="receiveModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="modal-title">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</div>
        <button id="rmClose" class="btn btn-ghost" aria-label="‡∏õ‡∏¥‡∏î">‚úï</button>
      </div>
      <div class="hint">‡∏Å‡∏£‡∏≠‡∏Å Customer / Location ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Part (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</div>
      <div class="modal-body">
        <div class="modal-row">
          <label>üè∑Ô∏è Part No</label>
          <input id="rmPartNo" class="modal-input" type="text" readonly>
        </div>
        <div class="modal-row">
          <label>üìõ Part name <span class="hint">(‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡πâ)</span></label>
          <input id="rmPartName" class="modal-input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô A2CU-..." />
        </div>
        <div class="modal-row">
          <label>üè¢ Customer</label>
          <input id="rmCustomer" class="modal-input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô FGT / SAHP / DAIKIN" list="rmCustomerList" />
          <datalist id="rmCustomerList"></datalist>
          </div>
        <div class="modal-row">
          <label>üìç Location</label>
          <input id="rmLocation" class="modal-input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô B1F2 / B7 / RACK-A1" />
        </div>
      </div>
      <div class="modal-foot">
        <button id="rmCancel" class="btn btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="rmSave" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

<script>
// Modal logic: openReceiveModal returns Promise<{customer,location,partName}>
(function(){
  // Load Customer options (once per page)
  let __customerOptionsLoaded = false;
  async function ensureCustomerOptions(){
    if (__customerOptionsLoaded) return;
    try{
      const setCus = new Set();

      // Optional static customers collection (if exists)
      try {
        const cSnap = await db.collection('/rooms/wipfg/customers').orderBy('name').limit(1000).get();
        if (!cSnap.empty) {
          cSnap.docs.forEach(d => { const n = (d.data()?.name)||d.id; if(n) setCus.add(String(n)); });
        }
      } catch(e){ /* collection may not exist; ignore */ }

      // Distinct customers from existing parts
      try {
        const pSnap = await db.collection('/rooms/wipfg/parts').orderBy('customer').limit(5000).get();
        pSnap.docs.forEach(d => { const c = d.data()?.customer; if(c) setCus.add(String(c)); });
      } catch(e){}

      const options = [...setCus].sort((a,b)=>a.localeCompare(b,'th'))
        .map(c => `<option value="${c.replace(/"/g,'&quot;')}"></option>`).join("");
      const dl = document.getElementById('rmCustomerList');
      if (dl) dl.innerHTML = options;
    } catch(e){}
    __customerOptionsLoaded = true;
  }

  const modal = document.getElementById('receiveModal');
  const fPart = document.getElementById('rmPartNo');
  const fName = document.getElementById('rmPartName');
  const fCus  = document.getElementById('rmCustomer');
  const fLoc  = document.getElementById('rmLocation');
  const btnSave = document.getElementById('rmSave');
  const btnCancel = document.getElementById('rmCancel');
  const btnClose = document.getElementById('rmClose');

  let resolver = null, rejecter = null, escHandler = null;

  // Prefill from localStorage
  function getLS(k){ try{return localStorage.getItem(k)||'';}catch(e){return '';} }
  function setLS(k,v){ try{localStorage.setItem(k,v)}catch(e){} }

  function show(){
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    setTimeout(()=>{ if (!fCus.value) fCus.focus(); else if(!fLoc.value) fLoc.focus(); else fName.focus(); }, 50);
    escHandler = (e)=>{ if(e.key === 'Escape'){ hide(); rejecter && rejecter(new Error('cancel')); } };
    document.addEventListener('keydown', escHandler);
  }
  function hide(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', escHandler);
  }
  function validate(){
    const c = fCus.value.trim();
    const l = fLoc.value.trim();
    if(!c){ fCus.focus(); return false; }
    if(!l){ fLoc.focus(); return false; }
    return { customer:c, location:l, partName: (fName.value||'').trim() || null };
  }

  window.openReceiveModal = async function(partNo){
    return new Promise(async (resolve, reject)=>{
      resolver = resolve; rejecter = reject;
      // Fill fields
      fPart.value = partNo || '';
      // Try prefill name from screen or catalog
      const labelName = (document.getElementById('partName')?.textContent||'').trim();
      if (labelName && labelName !== '-') fName.value = labelName; else fName.value = '';
      // Prefill customer/location from last use
      fCus.value = getLS('wipfg_last_customer') || '';
      fLoc.value = getLS('wipfg_last_location') || '';

      // Also try from catalog if name empty
      try{
        if ((!fName.value) && window.CATALOG && partNo){
          const snap = await CATALOG.doc(idFromPartNo(partNo)).get();
          if (snap.exists){
            const nm = (snap.data()||{}).partName || '';
            if(nm) fName.value = nm;
          }
        }
      }catch(e){}

      show();
    });
  };

  function submit(){
    const v = validate();
    if (!v) return;
    setLS('wipfg_last_customer', v.customer);
    setLS('wipfg_last_location', v.location);
    hide();
    resolver && resolver(v);
  }

  btnSave.addEventListener('click', submit);
  btnCancel.addEventListener('click', ()=>{ hide(); rejecter && rejecter(new Error('cancel')); });
  btnClose.addEventListener('click', ()=>{ hide(); rejecter && rejecter(new Error('cancel')); });
  // submit on Enter
  [fName, fCus, fLoc].forEach(el=>{
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); submit(); } });
  });
  // click outside to cancel
  modal.addEventListener('click', (e)=>{
    if (e.target === modal){ hide(); rejecter && rejecter(new Error('cancel')); }
  });
})();
</script>

  <script>
// Popup to show selected OUT Location in big text
  
function showOutPopup(locText){
  try { if (navigator.vibrate) navigator.vibrate([20,40]); } catch(e){}
  const overlay = document.createElement('div');
  overlay.id = 'outPopupOverlay';
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,0.55)';
  overlay.style.backdropFilter = 'blur(2px)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = '9999';
  overlay.style.transition = 'opacity 180ms ease-out';
  
  const box = document.createElement('div');
  box.style.background = 'var(--panel, #111827)';
  box.style.border = '1px solid rgba(255,255,255,0.15)';
  box.style.padding = '28px 36px';
  box.style.borderRadius = '20px';
  box.style.boxShadow = '0 10px 40px rgba(0,0,0,0.35)';
  box.style.textAlign = 'center';
  box.style.color = '#ffffff'; // ensure visible on dark bg
  
  const title = document.createElement('div');
  title.textContent = 'üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Location';
  title.style.fontSize = 'clamp(16px, 2.4vw, 22px)';
  title.style.opacity = '0.9';
  title.style.marginBottom = '10px';
  title.style.color = '#ffffff';
  
  const big = document.createElement('div');
  big.textContent = locText || '';
  big.style.fontWeight = '800';
  big.style.letterSpacing = '0.8px';
  big.style.lineHeight = '1.15';
  big.style.fontSize = 'clamp(34px, 6vw, 64px)';
  big.style.maxWidth = '80vw';
  big.style.wordBreak = 'break-word';
  big.style.color = '#ffffff';
  
  box.appendChild(title);
  box.appendChild(big);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
  
  const remove = () => {
    overlay.style.opacity = '0';
    setTimeout(() => overlay.remove(), 180);
  };
  overlay.addEventListener('click', remove);
  setTimeout(remove, 2200);
}
catch(e){}
    const overlay = document.createElement('div');
    overlay.id = 'outPopupOverlay';
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.background = 'rgba(0,0,0,0.55)';
    overlay.style.backdropFilter = 'blur(2px)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '9999';
    overlay.style.transition = 'opacity 180ms ease-out';
    
    const box = document.createElement('div');
    box.style.background = 'var(--panel, #111827)';
    box.style.border = '1px solid rgba(255,255,255,0.15)';
    box.style.padding = '28px 36px';
    box.style.borderRadius = '20px';
    box.style.boxShadow = '0 10px 40px rgba(0,0,0,0.35)';
    box.style.textAlign = 'center';
    
    const title = document.createElement('div');
    title.textContent = 'üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Location';
    title.style.fontSize = 'clamp(16px, 2.4vw, 22px)';
    title.style.opacity = '0.85';
    title.style.marginBottom = '10px';
    
    const big = document.createElement('div');
    big.textContent = locText || '';
    big.style.fontWeight = '800';
    big.style.letterSpacing = '0.8px';
    big.style.lineHeight = '1.15';
    big.style.fontSize = 'clamp(34px, 6vw, 64px)';
    big.style.maxWidth = '80vw';
    big.style.wordBreak = 'break-word';
    
    box.appendChild(title);
    box.appendChild(big);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
    
    const remove = () => {
      overlay.style.opacity = '0';
      setTimeout(() => overlay.remove(), 180);
    };
    overlay.addEventListener('click', remove);
    setTimeout(remove, 1700);
  }


</script>

<style id="version-badge-style">
#versionBadge{position:fixed; right:8px; bottom:8px; font:600 11px/1.4 system-ui,-apple-system; padding:6px 8px; border-radius:10px; background:#0f172a; color:#fff; opacity:.65; z-index:99999; border:1px solid rgba(255,255,255,.12)}
#versionBadge:hover{opacity:1}
</style>
<div id="versionBadge">WIPFG ‚Ä¢ OUT POPUP v12 (LONG)</div>


<script>
function showOutToast(msg){
  try { if (navigator.vibrate) navigator.vibrate(15); } catch(e){}
  const t = document.createElement('div');
  t.textContent = msg || '';
  t.style.position = 'fixed';
  t.style.left = '50%';
  t.style.bottom = '24px';
  t.style.transform = 'translateX(-50%)';
  t.style.padding = '10px 14px';
  t.style.background = '#111827';
  t.style.color = '#fff';
  t.style.border = '1px solid rgba(255,255,255,.12)';
  t.style.borderRadius = '10px';
  t.style.boxShadow = '0 8px 24px rgba(0,0,0,.3)';
  t.style.zIndex = '9999';
  t.style.font = '600 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto';
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .2s'; setTimeout(()=>t.remove(),220); }, 1600);
}
</script>


<script>
function showOutPopupInModal(locText){
  const modal = document.getElementById('locModal');
  if (!modal) { if (typeof showOutPopup === 'function') return showOutPopup(locText); return; }
  // Create local overlay within the modal stacking context
  const card = modal.querySelector('.modal-card') || modal.firstElementChild || modal;
  const overlay = document.createElement('div');
  overlay.className = 'loc-flash';
  overlay.style.position = 'absolute';
  overlay.style.inset = '0';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.background = 'rgba(0,0,0,0.45)';
  overlay.style.backdropFilter = 'blur(2px)';
  overlay.style.zIndex = '999';
  const box = document.createElement('div');
  box.style.background = 'rgba(17,24,39,0.95)';
  box.style.border = '1px solid rgba(255,255,255,.15)';
  box.style.borderRadius = '18px';
  box.style.padding = '22px 28px';
  box.style.textAlign = 'center';
  box.style.color = '#fff';
  const t = document.createElement('div');
  t.textContent = 'üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Location';
  t.style.fontSize = 'clamp(14px,2vw,18px)';
  t.style.opacity = '.9';
  t.style.marginBottom = '8px';
  const big = document.createElement('div');
  big.textContent = locText || '';
  big.style.fontWeight = '800';
  big.style.fontSize = 'clamp(34px,6vw,64px)';
  big.style.letterSpacing = '.8px';
  big.style.lineHeight = '1.1';
  big.style.maxWidth = '80%';
  big.style.wordBreak = 'break-word';
  box.appendChild(t);
  box.appendChild(big);
  overlay.appendChild(box);
  // Position the overlay relative to the card
  const prev = getComputedStyle(card).position;
  if (prev === 'static') card.style.position = 'relative';
  card.appendChild(overlay);
  setTimeout(()=>{ overlay.style.opacity='0'; overlay.style.transition='opacity .28s'; setTimeout(()=>overlay.remove(), 280); }, 1600);
}
</script>


<script>
function forceFlashOutModal(initial){
  try { if (navigator.vibrate) navigator.vibrate([12, 24]); } catch(e){}
  const modal = document.getElementById('locModal');
  const card = modal?.querySelector('.modal-card') || modal?.firstElementChild || modal;
  if (!card) return null;
  const overlay = document.createElement('div');
  overlay.id = 'locFlashOverlay';
  overlay.style.position = 'absolute';
  overlay.style.inset = '0';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.background = 'rgba(3,7,18,0.45)';
  overlay.style.backdropFilter = 'blur(2px)';
  overlay.style.zIndex = '10000';
  overlay.style.animation = 'fadeInFlash .18s ease-out';

  const wrap = document.createElement('div');
  wrap.style.position = 'relative';
  wrap.style.padding = '0';
  wrap.style.borderRadius = '28px';
  wrap.style.boxShadow = '0 20px 80px rgba(0,0,0,.5)';
  wrap.style.background = 'linear-gradient(180deg, rgba(30,41,59,0.95) 0%, rgba(2,6,23,0.95) 100%)';
  wrap.style.border = '1px solid rgba(255,255,255,.12)';
  wrap.style.transform = 'scale(0.96)';
  wrap.style.animation = 'popIn .18s ease-out forwards';

  const glow = document.createElement('div');
  glow.style.position = 'absolute';
  glow.style.inset = '-2px';
  glow.style.borderRadius = '30px';
  glow.style.pointerEvents = 'none';
  glow.style.boxShadow = '0 0 0 2px rgba(124,58,237,.35), 0 0 40px rgba(124,58,237,.2)';
  glow.style.filter = 'blur(1px)';
  glow.style.opacity = '.9';

  const box = document.createElement('div');
  box.style.padding = '28px 36px';
  box.style.textAlign = 'center';
  box.style.color = '#fff';

  // Checkmark circle
  const icon = document.createElement('div');
  icon.style.width = '80px';
  icon.style.height = '80px';
  icon.style.margin = '0 auto 14px';
  icon.style.borderRadius = '999px';
  icon.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
  icon.style.display = 'grid';
  icon.style.placeItems = 'center';
  icon.style.boxShadow = '0 8px 24px rgba(22,163,74,.45)';
  icon.style.animation = 'popIn .22s ease-out both';
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('viewBox', '0 0 24 24');
  svg.setAttribute('width', '44'); svg.setAttribute('height', '44');
  svg.style.fill = 'none'; svg.style.stroke = 'white'; svg.style.strokeWidth = '2.6';
  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d','M20 6 9 17l-5-5');
  path.setAttribute('stroke-linecap','round'); path.setAttribute('stroke-linejoin','round');
  svg.appendChild(path); icon.appendChild(svg);

  const t = document.createElement('div');
  t.textContent = 'üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Location';
  t.style.fontSize = 'clamp(16px,2.2vw,22px)';
  t.style.opacity = '.9';
  t.style.marginBottom = '6px';

  const big = document.createElement('div');
  big.id = 'locFlashText';
  big.textContent = initial || '...';
  big.style.fontWeight = '900';
  big.style.fontSize = 'clamp(42px,7vw,88px)';
  big.style.letterSpacing = '0.8px';
  big.style.lineHeight = '1.06';
  big.style.maxWidth = '82vw';
  big.style.wordBreak = 'break-word';

  box.appendChild(icon);
  box.appendChild(t);
  box.appendChild(big);
  wrap.appendChild(glow);
  wrap.appendChild(box);

  // ensure relative
  const prev = getComputedStyle(card).position;
  if (prev === 'static') card.style.position = 'relative';
  overlay.appendChild(wrap);
  card.appendChild(overlay);
  return overlay;
}
</script>


<script>
function showOutPopupGlobal(initial){
  try { if (navigator.vibrate) navigator.vibrate([10, 18]); } catch(e){}
  const id = 'globalOutFlashOverlay';
  let overlay = document.getElementById(id);
  if (overlay) overlay.remove();
  overlay = document.createElement('div');
  overlay.id = id;
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.background = 'rgba(3,7,18,0.45)';
  overlay.style.backdropFilter = 'blur(2px)';
  overlay.style.zIndex = '100000';
  overlay.style.animation = 'fadeInFlash .18s ease-out';
  const wrap = document.createElement('div');
  wrap.style.position = 'relative';
  wrap.style.padding = '0';
  wrap.style.borderRadius = '28px';
  wrap.style.boxShadow = '0 20px 80px rgba(0,0,0,.5)';
  wrap.style.background = 'linear-gradient(180deg, rgba(30,41,59,0.95) 0%, rgba(2,6,23,0.95) 100%)';
  wrap.style.border = '1px solid rgba(255,255,255,.12)';
  wrap.style.transform = 'scale(0.96)';
  wrap.style.animation = 'popIn .18s ease-out forwards';
  const glow = document.createElement('div');
  glow.style.position = 'absolute';
  glow.style.inset = '-2px';
  glow.style.borderRadius = '30px';
  glow.style.pointerEvents = 'none';
  glow.style.boxShadow = '0 0 0 2px rgba(124,58,237,.35), 0 0 40px rgba(124,58,237,.2)';
  glow.style.filter = 'blur(1px)';
  glow.style.opacity = '.9';
  const box = document.createElement('div');
  box.style.padding = '28px 36px';
  box.style.textAlign = 'center';
  box.style.color = '#fff';
  const icon = document.createElement('div');
  icon.style.width = '80px'; icon.style.height = '80px'; icon.style.margin = '0 auto 14px';
  icon.style.borderRadius = '999px';
  icon.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
  icon.style.display = 'grid'; icon.style.placeItems = 'center';
  icon.style.boxShadow = '0 8px 24px rgba(22,163,74,.45)';
  icon.style.animation = 'popIn .22s ease-out both';
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('viewBox', '0 0 24 24'); svg.setAttribute('width', '44'); svg.setAttribute('height', '44');
  svg.style.fill = 'none'; svg.style.stroke = 'white'; svg.style.strokeWidth = '2.6';
  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d','M20 6 9 17l-5-5'); path.setAttribute('stroke-linecap','round'); path.setAttribute('stroke-linejoin','round');
  svg.appendChild(path); icon.appendChild(svg);
  const t = document.createElement('div');
  t.textContent = 'üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Location';
  t.style.fontSize = 'clamp(16px,2.2vw,22px)'; t.style.opacity = '.9'; t.style.marginBottom = '6px';
  const big = document.createElement('div');
  big.id = 'globalOutFlashText';
  big.textContent = initial || '...';
  big.style.fontWeight = '900'; big.style.fontSize = 'clamp(64px,9vw,140px)';
  big.style.letterSpacing = '0.8px'; big.style.lineHeight = '1.06';
  big.style.maxWidth = '82vw'; big.style.wordBreak = 'break-word';
  box.appendChild(icon); box.appendChild(t); box.appendChild(big);
  wrap.appendChild(glow); wrap.appendChild(box);
  overlay.appendChild(wrap);
  document.body.appendChild(overlay);
  // auto remove in ~1.2s
  setTimeout(()=>{ overlay.style.opacity='0'; overlay.style.transition='opacity .32s'; setTimeout(()=>overlay.remove(), 320); }, 3000);
  return overlay;
}
</script>

</body>
</html>